<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mordzix Chatbox</title>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 18px; }
    #row { display: flex; gap: 10px; align-items: center; }
    #token { width: 420px; }
    #msg { flex: 1; }
    button { padding: 10px 14px; }
    #out { white-space: pre-wrap; border: 1px solid #ddd; padding: 12px; height: 60vh; overflow: auto; margin-top: 12px; }
    #typing { display:inline-block; min-width: 22px; margin-left: 6px; opacity: .75; }
  </style>
</head>
<body>
  <h2>Mordzix Chatbox (SSE POST stream)</h2>

  <div id="row">
    <input id="token" placeholder="AUTH_TOKEN" autocomplete="off" />
    <input id="msg" placeholder="Wiadomość..." autocomplete="off" />
    <button id="send">Wyślij</button>
  </div>

  <div id="out"></div>

  <script>
    const out = document.getElementById("out");
    const btn = document.getElementById("send");
    const msg = document.getElementById("msg");
    const token = document.getElementById("token");

    let typingTimer = null;
    let typingPhase = 0;
    let typingOn = false;

    function scrollBottom() {
      out.scrollTop = out.scrollHeight;
    }

    function appendText(t) {
      out.textContent += t;
      scrollBottom();
    }

    function setTyping(on) {
      typingOn = on;
      if (!on) {
        if (typingTimer) clearInterval(typingTimer);
        typingTimer = null;
        return;
      }
      if (typingTimer) return;
      typingPhase = 0;
      typingTimer = setInterval(() => {
        // animacja "..." bez dopisywania do treści rozmowy
        // realizowana przez chwilowe przepisywanie końcówki
        // (bezpiecznie: na końcu tylko znak kursora)
        typingPhase = (typingPhase + 1) % 4;
      }, 250);
    }

    function renderCursor() {
      // prosty kursor: dopisujemy/odświeżamy " ▌" na końcu
      // robi się to przez trzymanie kursora w osobnym stanie:
      // tu najprościej: nic nie dopisujemy, a ping resetuje wrażenie życia.
    }

    async function postStream() {
      const t = token.value.trim();
      const m = msg.value.trim();
      if (!t || !m) return;

      appendText("\n\n---\nUSER: " + m + "\nASSISTANT: ");
      msg.value = "";
      setTyping(true);

      const resp = await fetch("http://127.0.0.1:8080/api/chat/assistant/stream", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + t
        },
        body: JSON.stringify({ message: m, user_id: "default" })
      });

      if (!resp.ok || !resp.body) {
        setTyping(false);
        appendText("\n[HTTP ERROR] " + resp.status + " " + (await resp.text()));
        return;
      }

      const reader = resp.body.getReader();
      const decoder = new TextDecoder("utf-8");
      let buf = "";

      while (true) {
        const { value, done } = await reader.read();
        if (done) break;

        buf += decoder.decode(value, { stream: true });

        let idx;
        while ((idx = buf.indexOf("\n\n")) !== -1) {
          const chunk = buf.slice(0, idx);
          buf = buf.slice(idx + 2);

          const lines = chunk.split("\n").map(x => x.trim());
          for (const line of lines) {
            if (!line.startsWith("data:")) continue;
            const payload = line.slice(5).trim();
            if (!payload) continue;

            try {
              const obj = JSON.parse(payload);
              if (!obj || !obj.event) continue;

              if (obj.event === "ping") {
                // UI “żyje” – nic nie dopisujemy do tekstu
                renderCursor();
              } else if (obj.event === "delta") {
                appendText(String(obj.data || ""));
              } else if (obj.event === "error") {
                setTyping(false);
                appendText("\n[ERROR] " + String(obj.data || ""));
              } else if (obj.event === "done") {
                setTyping(false);
              }
            } catch (e) {
              // ignoruj
            }
          }
        }
      }

      setTyping(false);
    }

    btn.addEventListener("click", postStream);
    msg.addEventListener("keydown", (e) => {
      if (e.key === "Enter") postStream();
    });
  </script>
</body>
</html>
